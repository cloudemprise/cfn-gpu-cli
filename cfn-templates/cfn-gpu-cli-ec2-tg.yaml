---
AWSTemplateFormatVersion: '2010-09-09'
Description: >
  A Target Group for the Network Loadbalancer associated with the Gaming
  service. Health Checks come from a webserver running on the same EC2 instance.

# ------------------------------------------


# ==========================================
Metadata: {}
# Metadata:


# ==========================================
# Parameters {}
Parameters:

  # ------------------------------------------
  # --- The Project Name
  ProjectName:
    Description: "The Name given to this Project."
    ConstraintDescription: "Name must satisfy S3 constraints."
    Type: String
    Default: "cfn-gpu-cli"
    MinLength: 3
    MaxLength: 63
    AllowedPattern:
      ^[a-zA-Z0-9.\-_]{1,255}$

  # ------------------------------------------
  # --- AWS-Specific Parameter VPC Id
  VPCID:
    Description: "VPC to associate with load balancer"
    Type: "AWS::EC2::VPC::Id"


# ==========================================
Conditions: {}
# Conditions:


# ==========================================
Resources:

  # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  #     NETWORK LOAD BALANCER DEFINITIONS
  # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


  # ------------------------------------------
  # --- Target Group Definition
  GamingDcvTargetGroup:
    Type: "AWS::ElasticLoadBalancingV2::TargetGroup"
    # .............................
    Properties:
      # - Careful!!! Variable limited to 32 characters
      Name: !Sub "${ProjectName}-tgp-dcv-${AWS::Region}"
      # .............................
      Tags:
        -
          Key: "Name"
          Value: "GamingDcvTargetGroup"
      # .............................
      TargetGroupAttributes:
        -
          Key: "deregistration_delay.timeout_seconds"
          Value: "300"
        - 
          Key: "deregistration_delay.connection_termination.enabled"
          Value: "true"
        -
          Key: "preserve_client_ip.enabled"
          Value: "true"
        -
          Key: "proxy_protocol_v2.enabled"
          Value: "false"
      # .............................
      VpcId: !Ref VPCID
      TargetType: "instance"
      Port: 8443
      Protocol: "TCP_UDP"
      # .............................
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 30
      HealthCheckPort: "8443"
      HealthCheckProtocol: "TCP"
      HealthCheckTimeoutSeconds: 10
      HealthyThresholdCount: 3
      UnhealthyThresholdCount: 3
      # .............................


  # ------------------------------------------
  # --- Target Group Definition
  GamingRdpTargetGroup:
    Type: "AWS::ElasticLoadBalancingV2::TargetGroup"
    # .............................
    Properties:
      # - Careful!!! Variable limited to 32 characters
      Name: !Sub "${ProjectName}-tgp-rdp-${AWS::Region}"
      # .............................
      Tags:
        -
          Key: "Name"
          Value: "GamingRdpTargetGroup"
      # .............................
      TargetGroupAttributes:
        -
          Key: "deregistration_delay.timeout_seconds"
          Value: "300"
        - 
          Key: "deregistration_delay.connection_termination.enabled"
          Value: "true"
        -
          Key: "preserve_client_ip.enabled"
          Value: "true"
        -
          Key: "proxy_protocol_v2.enabled"
          Value: "false"
      # .............................
      VpcId: !Ref VPCID
      Port: 3389
      Protocol: "TCP"
      TargetType: "instance"
      # .............................
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 30
      HealthCheckPort: "3389"
      HealthCheckProtocol: "TCP"
      HealthCheckTimeoutSeconds: 10
      HealthyThresholdCount: 3
      UnhealthyThresholdCount: 3
      # .............................


# ==========================================
# Outputs: {}
Outputs:

  # ------------------------------------------
  # --- EC2 Target Group ARN
  GamingDcvTargetGroupArn:
    Description: "Network Loadbalancer DCV Target Group ARN"
    Value: !Ref GamingDcvTargetGroup

  # ------------------------------------------
  # --- EC2 Target Group Name
  #GamingDcvTargetName:
  #  Description: "Network Loadbalancer DCV Target Group Name"
  #  Value: !GetAtt GamingDcvTargetGroup.TargetGroupName

  # ------------------------------------------
  # --- EC2 Target Group ARN
  GamingRdpTargetGroupArn:
    Description: "Network Loadbalancer RDP Target Group ARN"
    Value: !Ref GamingRdpTargetGroup

  # ------------------------------------------
  # --- EC2 Target Group Name
  #GamingRdpTargetName:
  #  Description: "Network Loadbalancer RDP Target Group Name"
  #  Value: !GetAtt GamingRdpTargetGroup.TargetGroupName
